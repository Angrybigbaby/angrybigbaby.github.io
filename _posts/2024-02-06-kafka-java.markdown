---
layout:     post
title:      "Java Client场景下Kafka的一些调优"
subtitle:   "生产者和消费者"
date:       2024-02-06
author:     "Bigbaby"
catalog:    true
tags:
  - Kafka
  - Java 
---

> 这次写点Java客户端场景下应用Kafka的一些问题

## 关于性能

Kafka性能优化的本质就是吞吐量优化。

结合Kafka代码来看也就是对kafka生产者和kafka消费者的性能优化上。

### 生产者

*对于Kafka生产者，主要通过异步发送和批量发送来提升性能：*

1. 异步发送
   
	 	Kafka同步发送会导致在接收到当前数据的ack之前阻塞后续数据，直到接收到ack后才发送下一条数据。
   
		在实际项目中，同步发送的方式能够提供强大的一致性语义保证，但对吞吐量有极大的负面影响。

		因此综合考虑，采取异步发送的方式。

		异步发送在执行的时候消费者线程不会被阻塞，不需等待上一条数据的ack即可发送下一条数据，因此可以配合批量发送的方式实现吞吐量最大化。

		在异步发送的基础上，配合retry参数可以实现将发送失败的消息异步重试，配合回调方法可以实现将发送失败的消息打印日志或发送告警。

2. 批量发送

		通过调整生产者配置项中的batch.size和linger.ms，可以实现批量发送消息的逻辑。通过增大每次发送时的消息条数，可以增大kafka生产者的吞吐量。

		其中batch.size对应每批次消息的大小，linger.ms对应每批次消息的延迟时间，两个条件满足任一条则触发发送逻辑，从而实现批量发送。

*批量发送必须基于异步发送的基础上实现。*

### 消费者

*对于kafka消费者，主要通过调整拉取消息条数等参数，多分区设计，以及特殊数据特殊处理三方面来提升消费性能：*

1. 批量消费
   
		通过调整消费者配置项中的max.poll.records可以实现控制每批次消费的消息条数，适当增大该参数即增大每批次消费的消息条数，从而实现吞吐量增加。

2. 多分区（并发消费）

		将kafka拓展为多分区后，对同一个消费者组而言可以相应的扩展消费者数量，同一时间段内多消费者意味着同时有多条数据被消费，在代码中多消费者对应的是多线程，因此提升kafka分区数可以理论上提升kafka消费者性能。

3. 特殊数据特殊处理

		Kafka对长数据支持非常不友好。在消费长数据的过程中消费者吞吐量会骤减。解决思路可以从提升消费者性能，以及优化数据结构着手。显然，优化数据结构是最简单，也是效果更好的方案。
		因此从这里可以得出，我们在开发的过程中不能只着眼于技术组件，更要看到全局，时刻掌握问题的关键。有时候就是需要结合具体的场景来得出解决方案。

		我们遇到的问题是有些业务系统系统单条数据较长，下游采集区处理过程性能较差，数据积压及Flink反压情况较严重。

		解决方案也很清晰，就是提前对数据进行切割，减小单条数据长度。

		此外对于个别业务系统的数据要做进一步处理。

		以某民航业务系统为例，该系统数据以长JSON为主，JSON中存在长list。我们此前的逻辑是在消费者消费到数据后立刻推送数据湖。在湖仓中以DataStream的形式起FlinkJob清洗。

		结果出现严重反压。我们分析这是有幸摸到了CPU的瓶颈。因为任何算子最终都是需要调CPU去处理的，对于这种长List处理时间就是慢。

		这也印证我们对DataStream API、Checkpoint机制、Hudi表结构、TM和JM资源分配等做了一系列优化但始终效果不好的事实。

		最终我们的方案是在Java Client消费者刚消费到数据的阶段即进行初步清洗，清洗逻辑为遍历该list，将每个list元素封装为一条单独的数据，以这种一变多的形式增加了数据条数，减小了每条数据的长度。

		这样做直接解决了反压问题。

> 其实这次主要想聊聊优化的方法论。如果我们去搜一个组件的性能优化，会看到无数的技术文章，把每一个技术点说得很透很细，让你觉得你学会了不得了的新知识，恨不得从床上爬起来立马就去公司生产环境实战一波。
> 
> 但事实是，性能优化很多时候要依赖实践和经验。
> 
> 所谓依赖实践，指的是会存在某些操作与理论脱节，但却谜之有效的情况。
>
> 所谓依赖经验，指的是从项目全局的角度来看，把组件级优化上升到项目架构级可能产生意想不到的效果。
>
> 因此作为开发，要不断践行理论与实践相结合这件事。用自己的所学所悟，去解释看似违背理论的现象，最终提升自己的技术理论水平。
>
> 还要把格局打开，着眼于上游、下游乃至项目全局。这不是让你推诿扯皮，而是让你站在技术经理的角度思考，如果我们要做一件事，那么在哪个环节做才是最优解。我始终认为，只会盯着代码的开发难成气候。
>
> 以上。
