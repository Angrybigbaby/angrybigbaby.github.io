---
layout:     post
title:      "关于Flink end to end exactly once的一些理解"
subtitle:   ""
date:       2023-04-15 18:33:00
author:     "Bigbaby"
tags:
    - Flink
---

> 最近一致性这个词已经被玩坏了，成为越来越多业务出身的领导和基础不扎实的架构师喜欢挂在嘴边的概念。
> 在此严正说明：分布式系统的一致性和我们今天要讨论的状态一致性是完全的两码事。
> 那么既然如此，不妨给我们今天要聊的一致性语义来下个定义。
# 关于一致性语义
对于流处理器内部来说，所谓的状态一致性，其实就是所说的计算结果要保证准确。 

一条数据不应该丢失，也不应该重复计算，在遇到故障时可以恢复状态，恢复以后的重新计算，结果应该也是完全正确的

流处理引擎通常为应用程序提供了三种数据处理语义：最多一次、至少一次和精确一次，不同处理语义的宽松定义(一致性由弱到强)：

1. 最多一次：At-most-once：数据可能丢失，但不会重复
   
    当任务故障时，最简单的做法是什么都不干，既不恢复丢失的状态，也不重播丢失的数据。At-most-once 语义的含义是最多处理一次事件。
   
2. 最少一次：At-least-once：数据可能重复，但不会丢失
   
    在大多数的真实应用场景，希望不丢失事件。这种类型的保障称为 at-leastonce，意思是所有的事件都得到了处理，而一些事件还可能被处理多次。
   
3. 精确一次：Exactly-once：数据既不会丢失，也不会重复

    恰好处理一次是最严格的保证，也是最难实现的。恰好处理一次语义不仅仅意味着没有事件丢失，还意味着针对每一个数据，内部状态仅仅更新一次。
   
    Flink的 checkpoint机制和故障恢复机制给Flink内部提供了精确一次的保证。
   
    需要注意的是，所谓精确一次并不是说精确到每个event只执行一次，而是每个event对状态（计算结果）的影响只有一次。

4. End-to-End Exactly-Once

    Flink 在1.4.0 版本引入『exactly-once』并支持『End-to-End Exactly-Once』“端到端的精确一次”语义。
   
    结果的正确性贯穿了整个流处理应用的始终，每一个组件都保证了它自己的一致性。
   
    Flink 应用从 Source 端开始到 Sink 端结束，数据必须经过的起始点和结束点。
   
相比而言，Exactly Once保证所有记录仅影响内部状态一次。而End-To-End Exactly Once保证所有记录仅影响内部和**外部状态**一次。

综上，End-To-End Exactly Once（端到端一致性语义）是Flink数据准确性级别最高的语义，但他的实现需要上下游组件的配合方可实现。

因此，我们聊到端到端精准一致性语义，需要结合Source和Sink的具体组件来具体分析。
