---
layout:     post
title:      "又一反压解决方案"
subtitle:   "这次是新东西"
date:       2023-07-13 21:00
author:     "Bigbaby"
tags:
    - Flink
---

> 我们目前应用的Flink版本是1.15.3。某天空闲时翻阅官方文档，想看看1.15.3有没有什么此前没注意到的新特性。结果意外发现了1.14的新特性缓冲消胀。
> 因为彼时1.15.3还算一个比较新的版本，社区讨论度不高，对于这项机制的应用经验也并不多。那么接下来我就从理论和实践的角度，分享下我对这项技术的认知。

# 什么是缓冲消胀

在传统场景下，我们只能通过配置缓冲区大小（BufferPool）来增加Flink应对数据积压时的承受能力。实现的方式是指定缓冲区的数量和大小。

然而问题在于，每次部署都是一组静态的参数，这意味着很难调整到一个完美的状态。而且在实际生产环境，数据必然存在高峰和低谷。峰时和谷时的最佳配置必然有差异，统一用一套参数必然导致资源浪费或资源不足。

Flink 1.14新引入的缓冲消胀机制尝试通过自动调整缓冲数据量到一个合理值来解决这个问题。

缓冲消胀功能机制会计算subtask可能达到的最大吞吐（始终保持繁忙状态时），并且通过调整缓冲数据量来使得数据的消费时间达到配置值。也就是说，Flink会预测一条数据流的趋势，并动态的自动给出最合理的配置。

# 如何操作

可以通过设置taskmanager.network.memory.buffer-debloat.enabled为true来开启缓冲消胀机制。 

通过设置taskmanager.network.memory.buffer-debloat.target为duration类型的值来指定消费缓冲数据的目标时间。默认值应该能满足大多数场景。

这个功能使用过去的吞吐数据来预测消费剩余缓冲数据的时间。如果预测不准，缓冲消胀机制会导致以下问题：

    没有足够的缓存数据来提供全量吞吐。
    
    有太多缓冲数据对checkpoint barrier推进或者非对齐的checkpoint的大小造成不良影响。
    
然而还有一种情况是**作业负载经常变化**（即，突如其来的数据高峰，定期的窗口聚合触发或者join），那么可能需要调整以下设置：

    taskmanager.network.memory.buffer-debloat.period：这是缓冲区大小重算的最小时间周期。周期越小，缓冲消胀机制的反应时间就越快，但是必要的计算会消耗更多的CPU。
    
    taskmanager.network.memory.buffer-debloat.samples：调整用于计算平均吞吐量的采样数。采集样本的频率可以通过taskmanager.network.memory.buffer-debloat.period来设置。样本数越少，缓冲消胀机制的反应时间就越快，但是当吞吐量突然飙升或者下降时，缓冲消胀机制计算的最佳缓冲数据量会更容易出错。
    
    taskmanager.network.memory.buffer-debloat.threshold-percentages：防止缓冲区大小频繁改变的优化（比如，新的大小跟旧的大小相差不大）。

# 监控指标

以下指标可以用来监控当前的缓冲区大小：

    estimatedTimeToConsumeBuffersMs：消费所有输入通道（input channel）中数据的总时间。
    debloatedBufferSize：当前的缓冲区大小。

# 其他问题

目前我们所讲到的吞吐计算和缓冲消胀发生在 subtask 层面。

如果subtask有很多不同的输入或者有一个合并的输入，缓冲消胀可能会导致低吞吐的输入有太多缓冲数据，而高吞吐输入的缓冲区数量可能太少而不够维持当前吞吐。

当不同的输入吞吐差别比较大时，这种现象会更加的明显。因此最好在测试阶段重点关注这种 subtask。

当前缓冲消胀仅在使用的缓冲区大小上设置**上限**。实际的缓冲区大小和个数保持不变。这意味着缓冲消胀机制不会减少FlinkJob的内存占用。这种情况下需要手动减少缓冲区的大小或者个数。

此外如果要减少缓冲数据量使其低于缓冲消胀当前允许的量，也需要手动的设置缓冲区的个数。

在默认配置下，缓冲消胀机制可能无法在高并行度（高于 200）下正确执行。如果观察到吞吐量降低或checkpoint时间高于预期，官方建议将浮动缓冲区的数量（taskmanager.network.memory.floating-buffers-per-gate）从默认值增加到至少**等于并行度**的数量。

出现问题的并行度的实际值根据作业的不同而不同，但通常应该大于几百。

> 后记：我司数据的特点是量大管饱，有较为固定的波峰波谷。尝试给了一个高于现缓冲区大小1G的缓冲消胀上限，但效果不能说没有，只能说感觉<s>内存喂了狗了</s>。具体是Flink的问题还是我们的问题，容我慢慢研究下。看到这如果各位也对这个技术有兴趣，欢迎随时交流。
